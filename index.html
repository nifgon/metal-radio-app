<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Metal Radio</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
       * { margin: 0; padding: 0; box-sizing: border-box; }
       html, body { height: 100%; overflow: hidden; }
       body {
            background-color: #000000;
            background-image: url('bg.png');
            background-size: contain;
            background-position: center;
            background-repeat: no-repeat;
            color: #ffffff;
            font-family: sans-serif;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .app-container {
            width: 100%; height: 100%; max-width: 450px; max-height: 850px;
            display: flex; flex-direction: column; align-items: center;
            justify-content: space-between; padding: 80px 20px 40px 20px; 
        }
        .content-top { display: flex; flex-direction: column; align-items: center; width: 100%; }
        .status-container { margin-bottom: 10px; display: flex; flex-direction: column; align-items: center; gap: 2px; }
        .on-air-label { font-size: 10px; text-transform: uppercase; letter-spacing: 2px; color: #ffffff; opacity: 0.6; }
        .program-label {
            font-size: 16px; font-weight: 700; text-transform: uppercase; 
            letter-spacing: 3px; color: #ff3333; text-shadow: 0 0 10px rgba(255, 0, 0, 0.4);
            min-height: 20px; 
        }
        .cover {
            height: 25vh; width: 25vh; max-height: 250px; max-width: 250px;
            min-height: 120px; min-width: 120px; background-color: #333;
            background-size: cover; background-position: center; border-radius: 15px;
            margin: 30px 0 20px 0; box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            background-image: url('cover.png');
        }
        .track-info { margin-bottom: 10px; width: 100%; text-align: center; }
        h2 { margin: 0 0 5px 0; font-size: 20px; line-height: 1.2; word-wrap: break-word;}
        p { margin: 0; opacity: 0.7; font-size: 14px; }
        button#play-btn {
            padding: 15px 50px; font-size: 20px; font-weight: bold;
            border: 2px solid #a61a1a; border-radius: 12px; background-color: #7a0909; 
            color: #ffffff; cursor: pointer; transition: all 0.2s ease;
            text-transform: uppercase; letter-spacing: 2px;
            box-shadow: 0 0 10px rgba(166, 26, 26, 0.3); margin-top: 10px;
        }
        button#play-btn:active { transform: scale(0.95); background-color: #a61a1a; }
        .artist-link-btn {
            display: none; margin-top: 15px; padding: 6px 15px; font-size: 10px;
            font-weight: bold; text-decoration: none; color: #ffffff;
            border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 15px;
            background-color: rgba(0, 0, 0, 0.5); transition: all 0.2s;
            text-transform: uppercase; letter-spacing: 1px; opacity: 0.8;
        }
        .artist-link-btn:hover { background-color: rgba(255, 255, 255, 0.2); border-color: #fff; opacity: 1; }
        .content-bottom { margin-top: auto; padding-bottom: 20px; }
        #history-btn {
            padding: 8px 24px; font-size: 11px; border-radius: 999px;
            border: 1px solid #444; background: rgba(0,0,0,0.6);
            color: #fff; text-transform: uppercase; letter-spacing: 1px; cursor: pointer;
        }
        .history-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.85);
            display: none; align-items: center; justify-content: center; z-index: 100;
        }
        .history-panel {
            width: 90%; max-width: 360px; max-height: 70vh; background: #111;
            border-radius: 16px; padding: 15px; box-shadow: 0 0 20px rgba(0,0,0,0.7);
            display: flex; flex-direction: column;
        }
        .history-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 10px; font-size: 13px; text-transform: uppercase; letter-spacing: 1px;
        }
        .history-close { cursor: pointer; opacity: 0.7; }
        .history-list { font-size: 12px; line-height: 1.4; overflow-y: auto; padding-right: 4px; }
        .history-item-time { color: #777; font-size: 11px; }
        .history-item-title { color: #fff; }

        /* ‚úÖ –ö–ù–û–ü–ö–ê –õ–ê–ô–ö–ê */
        #like-btn {
            position: fixed; top: 20px; right: 20px; z-index: 50;
            width: 56px; height: 56px; border-radius: 50%;
            background: rgba(255,0,0,0.8); border: none; color: white;
            font-size: 24px; cursor: pointer; box-shadow: 0 4px 16px rgba(255,0,0,0.4);
            transition: all 0.2s ease; display: none;
        }
        #like-btn:hover { transform: scale(1.1); background: rgba(255,0,0,1); }
        #like-btn:active { transform: scale(0.95); }
        #like-btn.success { background: rgba(0,255,0,0.8); }
    </style>
</head>
<body>
    <!-- ‚úÖ –ë–´–°–¢–†–ê–Ø –ó–ê–ì–†–£–ó–ö–ê: preload="metadata" -->
    <audio id="radio-player" preload="metadata">
        <source src="https://myradio24.org/ovodtune" type="audio/mpeg">
    </audio>

    <div class="app-container">
        <div class="content-top">
            <div class="status-container">
                <div class="on-air-label">–í –≠–§–ò–†–ï</div>
                <div id="program-label" class="program-label">–ó–ê–ì–†–£–ó–ö–ê...</div>
            </div>
            <div class="cover" id="album-cover"></div>
            <div class="track-info">
                <h2 id="song-title">Metal Radio</h2>
                <p id="artist-name">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
            </div>
            <button id="play-btn">PLAY</button>
            <a id="artist-link" href="#" class="artist-link-btn">TELEGRAM</a>
        </div>
        <div class="content-bottom">
            <button id="history-btn">–†–∞–Ω–µ–µ –≤ —ç—Ñ–∏—Ä–µ</button>
        </div>
    </div>

    <!-- ‚úÖ –ö–ù–û–ü–ö–ê –õ–ê–ô–ö–ê -->
    <button id="like-btn">‚ù§Ô∏è</button>

    <!-- –û–í–ï–†–õ–ï–ô –ò–°–¢–û–†–ò–ò -->
    <div id="history-overlay" class="history-overlay">
        <div class="history-panel">
            <div class="history-header">
                <span>–ò—Å—Ç–æ—Ä–∏—è —ç—Ñ–∏—Ä–∞</span>
                <span id="history-close" class="history-close">‚úï</span>
            </div>
            <div id="history-list" class="history-list">–ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏...</div>
        </div>
    </div>

    <script>
        window.Telegram.WebApp.ready();
        window.Telegram.WebApp.expand();

        const audio = document.getElementById('radio-player');
        const btn = document.getElementById('play-btn');
        const titleEl = document.getElementById('song-title');
        const artistEl = document.getElementById('artist-name');
        const programLabelEl = document.getElementById('program-label');
        const artistLinkEl = document.getElementById('artist-link');
        const likeBtn = document.getElementById('like-btn');
        const historyBtn = document.getElementById('history-btn');
        const historyOverlay = document.getElementById('history-overlay');
        const historyClose = document.getElementById('history-close');
        const historyList = document.getElementById('history-list');

        const USER_LOGIN = 'ovodtune'; 
        const artistLinks = {
            "netherlands": "https://t.me/ovod_radio",
            "torche": "https://t.me/slipknot",
            "helms alee": "https://t.me/ovod_radio",
            "red lama": "https://t.me/ovod_radio"
        };

        let currentTrack = '';

        // ‚úÖ iOS-FIX: –ö–Ω–æ–ø–∫–∞ –∫–∞–Ω–∞–ª–∞ —Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º
        artistLinkEl.addEventListener('click', (e) => {
            e.preventDefault();
            const url = artistLinkEl.href;
            window.Telegram.WebApp.showConfirm(`üé∏ –ü–µ—Ä–µ–π—Ç–∏ –≤ –∫–∞–Ω–∞–ª?`, (confirmed) => {
                if (confirmed) window.Telegram.WebApp.openTelegramLink(url);
            });
        });

        // –ò—Å—Ç–æ—Ä–∏—è
        historyBtn.addEventListener('click', () => historyOverlay.style.display = 'flex');
        historyClose.addEventListener('click', () => historyOverlay.style.display = 'none');
        historyOverlay.addEventListener('click', (e) => {
            if (e.target === historyOverlay) historyOverlay.style.display = 'none';
        });

        // ‚úÖ –ö–ù–û–ü–ö–ê –õ–ê–ô–ö–ê: Artist - Song –≤ —á–∞—Ç
        likeBtn.addEventListener('click', () => {
            if (currentTrack) {
                const original = likeBtn.innerHTML;
                likeBtn.innerHTML = '‚úì'; likeBtn.classList.add('success');
                
                window.Telegram.WebApp.openTelegramLink(
                    `https://t.me/share/url?url=&text=${encodeURIComponent(currentTrack)}`
                );
                
                setTimeout(() => {
                    likeBtn.innerHTML = original;
                    likeBtn.classList.remove('success');
                }, 2000);
            }
        });

        // ‚úÖ –ü–õ–ï–ï–†: –ë—ã—Å—Ç—Ä–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ + —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
        function updatePlayButton() {
            btn.textContent = audio.paused ? 'PLAY' : 'PAUSE';
        }

        btn.addEventListener('click', async () => {
            try {
                if (audio.paused) {
                    await audio.play();
                } else {
                    audio.pause();
                }
            } catch(e) {
                console.error('Play error:', e);
                btn.textContent = 'ERROR';
                setTimeout(() => updatePlayButton(), 2000);
            }
        });

        audio.addEventListener('play', updatePlayButton);
        audio.addEventListener('pause', updatePlayButton);
        audio.addEventListener('loadstart', () => btn.textContent = 'LOADING...');
        audio.addEventListener('canplay', () => updatePlayButton());

        async function updateMetadata() {
            try {
                const response = await fetch(`https://myradio24.com/users/${USER_LOGIN}/status.json?t=${Date.now()}`);
                const data = await response.json();

                let showName = "OVOD RADIO"; 
                if (data.playlist?.trim()) showName = data.playlist;
                else if (data.djname?.trim()) showName = data.djname;
                else if (data.streamname?.trim()) showName = data.streamname;
                programLabelEl.textContent = showName.replace(/_/g, " ").replace(".m3u", "");

                const fullString = data.song || "Metal Radio Live";
                const parts = fullString.split(' - ');
                const artist = parts[0]?.trim() || '';
                const song = parts[1]?.trim() || '';

                currentTrack = song ? `${artist} - ${song}` : fullString;
                titleEl.textContent = song || artist || 'Metal Radio';
                artistEl.textContent = song ? artist : '–°–µ–π—á–∞—Å –∏–≥—Ä–∞–µ—Ç';

                // –ê—Ä—Ç–∏—Å—Ç —Å—Å—ã–ª–∫–∞
                const artistKey = artist.toLowerCase();
                if (artistLinks[artistKey]) {
                    artistLinkEl.href = artistLinks[artistKey];
                    artistLinkEl.style.display = "inline-block";
                    artistLinkEl.textContent = `–ö–ê–ù–ê–õ ${artist.toUpperCase()}`;
                } else {
                    artistLinkEl.style.display = "none";
                }

                // ‚úÖ –ü–û–ö–ê–ó–´–í–ê–ï–ú –õ–ê–ô–ö –µ—Å–ª–∏ –µ—Å—Ç—å —Ç—Ä–µ–∫
                likeBtn.style.display = currentTrack && currentTrack !== 'Metal Radio Live' ? 'block' : 'none';

                // –ò—Å—Ç–æ—Ä–∏—è
                if (Array.isArray(data.songs) && data.songs.length > 0) {
                    const lastSongs = data.songs.slice(-10).reverse();
                    let html = '';
                    lastSongs.forEach(item => {
                        const time = item.time || '';
                        const a = item.artist || '';
                        const t = item.songtitle || '';
                        const full = t ? `${a} - ${t}` : (item.song || '');
                        html += `
                            <div class="history-item">
                                <div class="history-item-time">${time}</div>
                                <div class="history-item-title">${full}</div>
                            </div><hr style="border:0;border-top:1px solid #222;margin:4px 0;">`;
                    });
                    historyList.innerHTML = html;
                } else {
                    historyList.innerHTML = "–ò—Å—Ç–æ—Ä–∏—è –ø–æ–∫–∞ –ø—É—Å—Ç–∞.";
                }

                // MediaSession
                if ('mediaSession' in navigator) {
                    navigator.mediaSession.metadata = new MediaMetadata({
                        title: song || artist,
                        artist: song ? artist : showName,
                        artwork: [{ src: 'cover.png', sizes: '512x512', type: 'image/png' }]
                    });
                }
            } catch (error) { console.error("–û—à–∏–±–∫–∞:", error); }
        }

        updateMetadata();
        setInterval(updateMetadata, 10000);

        if ('mediaSession' in navigator) {
            navigator.mediaSession.setActionHandler('play', () => audio.play().catch(console.error));
            navigator.mediaSession.setActionHandler('pause', () => audio.pause());
        }
    </script>
</body>
</html>
